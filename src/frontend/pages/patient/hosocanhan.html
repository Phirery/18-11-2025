<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªì S∆° B·ªánh Nh√¢n</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .profile-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            overflow: hidden;
            max-width: 1100px;
            margin: 0 auto;
        }
        
        .profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            display: flex;
            align-items: center;
            gap: 25px;
        }
        
        .profile-img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 4px solid white;
            object-fit: cover;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .profile-info {
            color: white;
            flex: 1;
        }
        
        .profile-info h2 {
            margin: 0 0 8px 0;
            font-size: 28px;
            font-weight: 600;
        }
        
        .profile-info p {
            margin: 0;
            opacity: 0.95;
            font-size: 15px;
        }
        
        .content-section {
            padding: 30px;
        }
        
        .info-box {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .info-box h5 {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .info-label {
            color: #666;
            font-size: 13px;
            font-weight: 500;
        }
        
        .info-value {
            color: #333;
            font-size: 16px;
            font-weight: 600;
        }
        
        .table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .table {
            margin: 0;
        }
        
        .table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .table thead th {
            border: none;
            padding: 12px;
            font-weight: 600;
            font-size: 14px;
        }
        
        .table tbody td {
            padding: 12px;
            vertical-align: middle;
            font-size: 14px;
        }
        
        .badge-premium {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-standard {
            background: #6c757d;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
            border-width: 0.3em;
        }

        .alert {
            border-radius: 10px;
            padding: 15px 20px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state i {
            font-size: 48px;
            color: #ccc;
            margin-bottom: 15px;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-confirmed {
            background: #d4edda;
            color: #155724;
        }
        
        .status-pending {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status-completed {
            background: #d4edda;
            color: #155724;
        }
        
        .accordion-item {
            border: 1px solid #e0e0e0;
            border-radius: 10px !important;
            margin-bottom: 12px;
            overflow: hidden;
        }
        
        .accordion-button {
            background: #f8f9fa;
            color: #333;
            font-weight: 600;
            padding: 15px 20px;
        }
        
        .accordion-button:not(.collapsed) {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .accordion-button:focus {
            box-shadow: none;
        }
        
        .accordion-body {
            padding: 20px;
            background: #fafafa;
        }
        
        .history-detail {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .history-detail p {
            margin: 8px 0;
            font-size: 14px;
        }
        
        .btn-edit {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 35px;
            border-radius: 25px;
            font-weight: 600;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .btn-edit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
            color: white;
        }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        @media (max-width: 768px) {
            .profile-header {
                flex-direction: column;
                text-align: center;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="profile-card">
            <!-- Header -->
            <div class="profile-header">
                <img id="patientAvatar" src="https://ui-avatars.com/api/?name=User&size=100&background=667eea&color=fff&bold=true" alt="Avatar" class="profile-img">
                <div class="profile-info">
                    <h2 id="patientName">ƒêang t·∫£i...</h2>
                    <p><i class="fas fa-id-card me-2"></i><span id="patientCode">M√£ b·ªánh nh√¢n: ---</span></p>
                </div>
            </div>
            
            <!-- Content -->
            <div class="content-section">
                <!-- Loading State cho th√¥ng tin c√° nh√¢n -->
                <div id="personalInfoLoading" class="loading-spinner" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">ƒêang t·∫£i th√¥ng tin...</span>
                    </div>
                </div>

                <!-- Error State cho th√¥ng tin c√° nh√¢n -->
                <div id="personalInfoError" class="alert alert-danger" style="display: none;">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <span id="personalInfoErrorMessage"></span>
                    <button class="btn btn-sm btn-danger ms-3" onclick="loadPersonalInfo()">
                        Th·ª≠ l·∫°i
                    </button>
                </div>

                <!-- Th√¥ng tin c√° nh√¢n -->
                <div id="personalInfoBox" class="info-box">
                    <h5><i class="fas fa-user-circle"></i> Th√¥ng Tin C√° Nh√¢n</h5>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">H·ªç v√† t√™n</span>
                            <span class="info-value" id="infoHoTen">---</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Ng√†y sinh</span>
                            <span class="info-value" id="infoNgaySinh">---</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Gi·ªõi t√≠nh</span>
                            <span class="info-value" id="infoGioiTinh">---</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">S·ªë th·∫ª BHYT</span>
                            <span class="info-value" id="infoSoBHYT">---</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">S·ªë ƒëi·ªán tho·∫°i</span>
                            <span class="info-value" id="infoSoDienThoai">---</span>
                        </div>
                    </div>
                </div>
                
                <!-- L·ªãch kh√°m s·∫Øp t·ªõi -->
                <div class="info-box">
                    <h5>
                        <i class="fas fa-calendar-check"></i> L·ªãch Kh√°m S·∫Øp T·ªõi
                        <button class="btn btn-sm btn-outline-primary ms-auto" onclick="loadUpcomingAppointments()">
                            <i class="fas fa-sync-alt"></i> T·∫£i l·∫°i
                        </button>
                    </h5>

                    <div id="appointmentLoadingState" class="loading-spinner" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">ƒêang t·∫£i...</span>
                        </div>
                    </div>

                    <div id="appointmentErrorState" class="alert alert-danger" style="display: none;">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <span id="appointmentErrorMessage"></span>
                        <button class="btn btn-sm btn-danger ms-3" onclick="loadUpcomingAppointments()">
                            Th·ª≠ l·∫°i
                        </button>
                    </div>

                    <div id="appointmentEmptyState" class="empty-state" style="display: none;">
                        <i class="fas fa-calendar-times"></i>
                        <p>Ch∆∞a c√≥ l·ªãch kh√°m s·∫Øp t·ªõi</p>
                    </div>

                    <div id="appointmentTableContainer" class="table-container">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>M√£ l·ªãch kh√°m</th>
                                        <th>Ng√†y kh√°m</th>
                                        <th>Gi·ªù kh√°m</th>
                                        <th>G√≥i kh√°m</th>
                                        <th>Chuy√™n khoa</th>
                                        <th>B√°c sƒ©</th>
                                        <th>Tr·∫°ng th√°i</th>
                                    </tr>
                                </thead>
                                <tbody id="appointmentTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- L·ªãch s·ª≠ kh√°m b·ªánh -->
                <div class="info-box">
                    <h5><i class="fas fa-history"></i> L·ªãch S·ª≠ Kh√°m B·ªánh</h5>
                    <div class="accordion" id="historyAccordion">
                        <!-- L·∫ßn kh√°m 1 -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#history1">
                                    <i class="fas fa-file-medical-alt me-2"></i>
                                    <strong>LK-2024-089</strong> - 15/10/2024 - N·ªôi khoa - BS. Tr·∫ßn VƒÉn B
                                </button>
                            </h2>
                            <div id="history1" class="accordion-collapse collapse show" data-bs-parent="#historyAccordion">
                                <div class="accordion-body">
                                    <div class="history-detail">
                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <p><strong>Ng√†y kh√°m:</strong> 15/10/2024</p>
                                                <p><strong>Gi·ªù kh√°m:</strong> 10:00</p>
                                            </div>
                                            <div class="col-md-4">
                                                <p><strong>G√≥i kh√°m:</strong> <span class="badge-standard">Th∆∞·ªùng</span></p>
                                                <p><strong>Chuy√™n khoa:</strong> N·ªôi khoa</p>
                                            </div>
                                            <div class="col-md-4">
                                                <p><strong>B√°c sƒ©:</strong> BS. Tr·∫ßn VƒÉn B</p>
                                                <p><strong>Tr·∫°ng th√°i:</strong> <span class="status-badge status-completed">Ho√†n th√†nh</span></p>
                                            </div>
                                        </div>
                                        <hr>
                                        <p><strong><i class="fas fa-stethoscope me-2"></i>Ch·∫©n ƒëo√°n:</strong> Vi√™m h·ªçng c·∫•p</p>
                                        <p><strong><i class="fas fa-prescription me-2"></i>ƒêi·ªÅu tr·ªã:</strong> Paracetamol 500mg - 2 l·∫ßn/ng√†y x 5 ng√†y</p>
                                        <p><strong><i class="fas fa-notes-medical me-2"></i>Ghi ch√∫:</strong> Ngh·ªâ ng∆°i, u·ªëng nhi·ªÅu n∆∞·ªõc, t√°i kh√°m sau 1 tu·∫ßn n·∫øu kh√¥ng kh·ªèi</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- N√∫t ch·ªânh s·ª≠a -->
                <div class="text-center mt-4">
                    <button class="btn btn-edit">
                        <i class="fas fa-edit me-2"></i>Ch·ªânh S·ª≠a H·ªì S∆°
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_CONFIG = {
            personalInfo: "http://localhost/DO_AN_1/code_doan1/src/backend/api/patient/thongtincanhan.php",
            upcomingAppointments: "http://localhost/DO_AN_1/code_doan1/src/backend/api/patient/lichkham.php"
        };

        // H√†m load th√¥ng tin c√° nh√¢n
        async function loadPersonalInfo() {
            const loadingState = document.getElementById('personalInfoLoading');
            const errorState = document.getElementById('personalInfoError');
            const infoBox = document.getElementById('personalInfoBox');

            try {
                loadingState.style.display = 'flex';
                errorState.style.display = 'none';
                infoBox.style.opacity = '0.5';

                console.log('üîç ƒêang g·ªçi API th√¥ng tin c√° nh√¢n...');

                const response = await fetch(API_CONFIG.personalInfo, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Response status:', response.status);

                const responseText = await response.text();
                console.log('Response text:', responseText);

                loadingState.style.display = 'none';
                infoBox.style.opacity = '1';

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                let data;
                try {
                    data = JSON.parse(responseText);
                    console.log('‚úÖ Parsed data:', data);
                } catch (parseError) {
                    console.error('‚ùå JSON Parse Error:', parseError);
                    throw new Error('Ph·∫£n h·ªìi t·ª´ server kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng JSON');
                }

                if (data.requireLogin) {
                    alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!');
                    window.location.href = 'login.html';
                    return;
                }

                if (data.success && data.data) {
                    renderPersonalInfo(data.data);
                } else {
                    throw new Error(data.message || 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin c√° nh√¢n');
                }

            } catch (error) {
                console.error('‚ùå Error loading personal info:', error);
                loadingState.style.display = 'none';
                infoBox.style.opacity = '1';
                errorState.style.display = 'block';
                document.getElementById('personalInfoErrorMessage').textContent = 
                    error.message || 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin c√° nh√¢n. Vui l√≤ng th·ª≠ l·∫°i sau.';
            }
        }

        // H√†m hi·ªÉn th·ªã th√¥ng tin c√° nh√¢n
        function renderPersonalInfo(data) {
            console.log('üìù Rendering personal info:', data);

            // C·∫≠p nh·∫≠t header
            const fullName = data.tenBenhNhan || 'Ch∆∞a c·∫≠p nh·∫≠t';
            document.getElementById('patientName').textContent = fullName;
            document.getElementById('patientCode').textContent = `M√£ b·ªánh nh√¢n: ${data.maBenhNhan || '---'}`;
            
            // C·∫≠p nh·∫≠t avatar
            const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(fullName)}&size=100&background=667eea&color=fff&bold=true`;
            document.getElementById('patientAvatar').src = avatarUrl;

            // C·∫≠p nh·∫≠t th√¥ng tin chi ti·∫øt
            document.getElementById('infoHoTen').textContent = data.tenBenhNhan || 'Ch∆∞a c·∫≠p nh·∫≠t';
            document.getElementById('infoNgaySinh').textContent = data.ngaySinh || 'Ch∆∞a c·∫≠p nh·∫≠t';
            document.getElementById('infoGioiTinh').textContent = data.gioiTinh || 'Ch∆∞a c·∫≠p nh·∫≠t';
            document.getElementById('infoSoBHYT').textContent = data.soTheBHYT || 'Ch∆∞a c√≥';
            document.getElementById('infoSoDienThoai').textContent = data.soDienThoai || 'Ch∆∞a c·∫≠p nh·∫≠t';

            console.log('‚úÖ Personal info rendered successfully!');
        }

        // H√†m load l·ªãch kh√°m s·∫Øp t·ªõi
        async function loadUpcomingAppointments() {
            const loadingState = document.getElementById('appointmentLoadingState');
            const errorState = document.getElementById('appointmentErrorState');
            const emptyState = document.getElementById('appointmentEmptyState');
            const tableContainer = document.getElementById('appointmentTableContainer');
            const tableBody = document.getElementById('appointmentTableBody');

            try {
                loadingState.style.display = 'flex';
                errorState.style.display = 'none';
                emptyState.style.display = 'none';
                tableContainer.style.display = 'none';
                tableBody.innerHTML = '';

                console.log('üìÖ ƒêang g·ªçi API l·ªãch kh√°m...');

                const response = await fetch(API_CONFIG.upcomingAppointments, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Response status:', response.status);

                const responseText = await response.text();
                console.log('Response text:', responseText);

                loadingState.style.display = 'none';

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                let data;
                try {
                    data = JSON.parse(responseText);
                    console.log('Parsed data:', data);
                } catch (parseError) {
                    console.error('JSON Parse Error:', parseError);
                    throw new Error('Ph·∫£n h·ªìi t·ª´ server kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng JSON');
                }

                if (data.success && data.data && data.data.length > 0) {
                    renderAppointments(data.data);
                    tableContainer.style.display = 'block';
                } else {
                    emptyState.style.display = 'block';
                }

            } catch (error) {
                console.error('Error loading appointments:', error);
                loadingState.style.display = 'none';
                errorState.style.display = 'block';
                document.getElementById('appointmentErrorMessage').textContent = 
                    error.message || 'Kh√¥ng th·ªÉ t·∫£i l·ªãch kh√°m. Vui l√≤ng th·ª≠ l·∫°i sau.';
            }
        }

        // H√†m render l·ªãch kh√°m
        function renderAppointments(appointments) {
            const tableBody = document.getElementById('appointmentTableBody');
            tableBody.innerHTML = '';

            appointments.forEach(appointment => {
                const packageBadge = getPackageBadge(appointment.goiKham);
                const statusBadge = getStatusBadge(appointment.trangThai);

                tableBody.innerHTML += `
                    <tr>
                        <td><strong>${appointment.maLichKham}</strong></td>
                        <td>${appointment.ngayKham || 'N/A'}</td>
                        <td>${appointment.gioKham || 'N/A'}</td>
                        <td>${packageBadge}</td>
                        <td>${appointment.chuyenKhoa || 'N/A'}</td>
                        <td>${appointment.bacSi || 'N/A'}</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            });
        }

        function getPackageBadge(packageType) {
            if (!packageType) return '<span class="badge-standard">N/A</span>';
            
            const lower = packageType.toLowerCase();
            if (lower.includes('cao') || lower.includes('premium') || lower.includes('vip')) {
                return `<span class="badge-premium"><i class="fas fa-crown me-1"></i>${packageType}</span>`;
            }
            return `<span class="badge-standard">${packageType}</span>`;
        }

        function getStatusBadge(status) {
            if (!status) return '<span class="status-badge">N/A</span>';
            
            const lower = status.toLowerCase();
            if (lower.includes('xac nhan') || lower.includes('x√°c nh·∫≠n')) {
                return `<span class="status-badge status-confirmed">${status}</span>`;
            } else if (lower.includes('cho') || lower.includes('ch·ªù')) {
                return `<span class="status-badge status-pending">${status}</span>`;
            } else if (lower.includes('hoan thanh') || lower.includes('ho√†n th√†nh')) {
                return `<span class="status-badge status-completed">${status}</span>`;
            }
            return `<span class="status-badge">${status}</span>`;
        }

        // Load d·ªØ li·ªáu khi trang ƒë∆∞·ª£c t·∫£i
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Page loaded!');
            loadPersonalInfo();
            loadUpcomingAppointments();
        });
    </script>
</body>
</html>