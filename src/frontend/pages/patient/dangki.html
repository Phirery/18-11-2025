<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng Ký Bệnh Nhân - Hệ Thống Quản Lý Bệnh Viện</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .register-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            max-width: 1000px;
            width: 100%;
            display: flex;
            min-height: 700px;
            max-height: 95vh;
        }

        .register-left {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 60px 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .register-left .icon {
            font-size: 5rem;
            margin-bottom: 30px;
            opacity: 0.9;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .register-left h2 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .register-left p {
            font-size: 1.1rem;
            opacity: 0.9;
            line-height: 1.6;
        }

        .register-right {
            flex: 1;
            padding: 50px 50px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            overflow-y: auto;
            max-height: 90vh;
        }

        .register-header {
            margin-bottom: 25px;
            margin-top: 20px;
        }

        .register-header h2 {
            color: #333;
            font-weight: 700;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .register-header p {
            color: #666;
            font-size: 1rem;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 25px;
            gap: 10px;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            transition: all 0.3s;
        }

        .step.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.1);
        }

        .step.completed {
            background: #28a745;
            color: white;
        }

        .step-line {
            width: 50px;
            height: 2px;
            background: #e0e0e0;
        }

        .step-line.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .form-step {
            display: none;
        }

        .form-step.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 18px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group i {
            position: absolute;
            right: 15px;
            top: 43px;
            color: #999;
            cursor: pointer;
            transition: color 0.3s;
        }

        .form-group i:hover {
            color: #667eea;
        }

        .password-strength {
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            margin-top: 5px;
            overflow: hidden;
        }

        .password-strength-bar {
            height: 100%;
            width: 0;
            transition: all 0.3s;
        }

        .strength-weak { width: 33%; background: #dc3545; }
        .strength-medium { width: 66%; background: #ffc107; }
        .strength-strong { width: 100%; background: #28a745; }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-next, .btn-prev, .btn-register {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-next, .btn-register {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-next:hover, .btn-register:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-next:disabled, .btn-register:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-prev {
            background: #f5f5f5;
            color: #666;
        }

        .btn-prev:hover {
            background: #e0e0e0;
        }

        .login-link {
            text-align: center;
            margin-top: 25px;
            color: #666;
        }

        .login-link a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .login-link a:hover {
            text-decoration: underline;
        }

        .alert {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-size: 0.9rem;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .register-container {
                flex-direction: column;
                max-width: 500px;
            }

            .register-left {
                order: -1;
                padding: 40px 30px;
            }

            .register-left h2 {
                font-size: 2rem;
            }

            .register-left .icon {
                font-size: 3.5rem;
            }

            .register-right {
                padding: 40px 30px;
            }

            .register-header h2 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="register-container">
        <!-- Left Side -->
        <div class="register-left">
            <div class="icon">
                <i class="fas fa-user-injured"></i>
            </div>
            <h2>Đăng Ký Bệnh Nhân</h2>
            <p>Tạo tài khoản để trải nghiệm dịch vụ chăm sóc sức khỏe toàn diện. Đặt lịch khám, theo dõi sức khỏe và nhận tư vấn từ đội ngũ bác sĩ chuyên nghiệp.</p>
        </div>

        <!-- Right Side - Register Form -->
        <div class="register-right">
            <div class="register-header">
                <h2>Đăng Ký</h2>
                <p>Tạo tài khoản bệnh nhân mới</p>
            </div>

            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active" id="step1">1</div>
                <div class="step-line" id="line1"></div>
                <div class="step" id="step2">2</div>
            </div>

            <div id="registerAlert" class="alert"></div>
            <div id="loadingSpinner" class="loading-spinner">
                <div class="spinner"></div>
                <p style="margin-top: 10px; color: #666;">Đang xử lý...</p>
            </div>

            <form id="registerForm">
                <!-- Step 1: Account Information -->
                <div class="form-step active" id="formStep1">
                    <h4 style="margin-bottom: 20px; color: #667eea;">
                        <i class="fas fa-user-lock"></i> Thông Tin Tài Khoản
                    </h4>

                    <div class="form-group">
                        <label for="username">Tên đăng nhập <span style="color: red;">*</span></label>
                        <input type="text" id="username" name="username" placeholder="Nhập tên đăng nhập" required minlength="4">
                        <i class="fas fa-user"></i>
                    </div>

                    <div class="form-group">
                        <label for="email">Email <span style="color: red;">*</span></label>
                        <input type="email" id="email" name="email" placeholder="example@email.com" required>
                        <i class="fas fa-envelope"></i>
                    </div>

                    <div class="form-group">
                        <label for="password">Mật khẩu <span style="color: red;">*</span></label>
                        <input type="password" id="password" name="password" placeholder="Tạo mật khẩu (tối thiểu 6 ký tự)" required minlength="6">
                        <i class="fas fa-eye password-toggle" onclick="togglePassword('password')"></i>
                        <div class="password-strength">
                            <div class="password-strength-bar" id="strengthBar"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="confirm_password">Xác nhận mật khẩu <span style="color: red;">*</span></label>
                        <input type="password" id="confirm_password" name="confirm_password" placeholder="Nhập lại mật khẩu" required>
                        <i class="fas fa-eye password-toggle" onclick="togglePassword('confirm_password')"></i>
                    </div>

                    <div class="btn-group">
                        <button type="button" class="btn-next" onclick="nextStep()">
                            Tiếp theo <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Personal Information -->
                <div class="form-step" id="formStep2">
                    <h4 style="margin-bottom: 20px; color: #667eea;">
                        <i class="fas fa-id-card"></i> Thông Tin Cá Nhân
                    </h4>

                    <div class="form-group">
                        <label for="fullname">Họ và tên <span style="color: red;">*</span></label>
                        <input type="text" id="fullname" name="fullname" placeholder="Nhập họ và tên đầy đủ" required>
                        <i class="fas fa-user"></i>
                    </div>

                    <div class="form-group">
                        <label for="phone">Số điện thoại <span style="color: red;">*</span></label>
                        <input type="tel" id="phone" name="phone" placeholder="0123456789" pattern="[0-9]{10,11}" required>
                        <i class="fas fa-phone"></i>
                    </div>

                    <div class="form-group">
                        <label for="birthdate">Ngày sinh <span style="color: red;">*</span></label>
                        <input type="date" id="birthdate" name="birthdate" required>
                        <i class="fas fa-calendar"></i>
                    </div>

                    <div class="form-group">
                        <label for="gender">Giới tính <span style="color: red;">*</span></label>
                        <select id="gender" name="gender" required>
                            <option value="">Chọn giới tính</option>
                            <option value="nam">Nam</option>
                            <option value="nu">Nữ</option>
                            <option value="khac">Khác</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="bhyt">Số thẻ BHYT <span style="color: red;">*</span></label>
                        <input type="text" id="bhyt" name="bhyt" placeholder="VD: BH1893182141111" maxlength="15" required>
                        <i class="fas fa-id-card"></i>
                    </div>

                    <div class="btn-group">
                        <button type="button" class="btn-prev" onclick="prevStep()">
                            <i class="fas fa-arrow-left"></i> Quay lại
                        </button>
                        <button type="submit" class="btn-register" id="btnRegister">
                            <i class="fas fa-user-plus"></i> Đăng Ký
                        </button>
                    </div>
                </div>
            </form>

            <div class="login-link">
                Đã có tài khoản? <a href="dangnhap.html">Đăng nhập ngay</a>
            </div>
        </div>
    </div>

    <script>
        // ============= CẤU HÌNH ĐƯỜNG DẪN API =============
        // Thay đổi đường dẫn này theo cấu trúc thư mục của bạn:
        
        // Ví dụ:
        // Cùng thư mục: 'register_patient.php'
        // Thư mục con api: 'api/register_patient.php'
        // Thư mục cha backend: '../backend/register_patient.php'
        // Root của domain: '/register_patient.php'
        // URL đầy đủ: 'http://localhost/hospital/api/register_patient.php'
        
        const API_URL = 'http://localhost/DO_AN_1/code_doan1/src/backend/api/patient/register.php'; // ← THAY ĐỔI Ở ĐÂY
        
        // ==================================================

        let currentStep = 1;

        // Toggle password visibility
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling;
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Password strength checker
        document.getElementById('password').addEventListener('input', function() {
            const password = this.value;
            const strengthBar = document.getElementById('strengthBar');
            
            let strength = 0;
            if (password.length >= 6) strength++;
            if (password.length >= 10) strength++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
            if (/\d/.test(password)) strength++;
            if (/[^a-zA-Z\d]/.test(password)) strength++;
            
            strengthBar.className = 'password-strength-bar';
            
            if (strength <= 2) {
                strengthBar.classList.add('strength-weak');
            } else if (strength <= 4) {
                strengthBar.classList.add('strength-medium');
            } else {
                strengthBar.classList.add('strength-strong');
            }
        });

        // Next step
        function nextStep() {
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm_password').value;

            if (!username || username.length < 4) {
                showAlert('Tên đăng nhập phải có ít nhất 4 ký tự!', 'error');
                return;
            }

            if (!email || !email.includes('@')) {
                showAlert('Email không hợp lệ!', 'error');
                return;
            }

            if (!password || password.length < 6) {
                showAlert('Mật khẩu phải có ít nhất 6 ký tự!', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showAlert('Mật khẩu xác nhận không khớp!', 'error');
                return;
            }

            currentStep = 2;
            document.getElementById('formStep1').classList.remove('active');
            document.getElementById('formStep2').classList.add('active');
            
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step1').classList.add('completed');
            document.getElementById('line1').classList.add('active');
            document.getElementById('step2').classList.add('active');

            document.querySelector('.register-right').scrollTop = 0;
        }

        // Previous step
        function prevStep() {
            currentStep = 1;
            document.getElementById('formStep2').classList.remove('active');
            document.getElementById('formStep1').classList.add('active');
            
            document.getElementById('step1').classList.add('active');
            document.getElementById('step1').classList.remove('completed');
            document.getElementById('line1').classList.remove('active');
            document.getElementById('step2').classList.remove('active');

            document.querySelector('.register-right').scrollTop = 0;
        }

        // Validate birthdate
        document.getElementById('birthdate').addEventListener('change', function() {
            const selectedDate = new Date(this.value);
            const today = new Date();
            const age = today.getFullYear() - selectedDate.getFullYear();
            
            if (selectedDate > today) {
                showAlert('Ngày sinh không được là ngày trong tương lai!', 'error');
                this.value = '';
            } else if (age > 150) {
                showAlert('Ngày sinh không hợp lệ!', 'error');
                this.value = '';
            }
        });

        // Set max date for birthdate
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('birthdate').setAttribute('max', today);
        });

        // Form submission
        document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const phone = document.getElementById('phone').value;
            const birthdate = document.getElementById('birthdate').value;
            const btnRegister = document.getElementById('btnRegister');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            if (!/^[0-9]{10,11}$/.test(phone)) {
                showAlert('Số điện thoại không hợp lệ! Vui lòng nhập 10-11 chữ số.', 'error');
                return;
            }

            if (!birthdate) {
                showAlert('Vui lòng chọn ngày sinh!', 'error');
                return;
            }
            
            // Disable button và hiển thị loading
            btnRegister.disabled = true;
            btnRegister.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';
            loadingSpinner.style.display = 'block';
            
            const formData = new FormData(this);
            
            fetch(API_URL, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                // Kiểm tra status code
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status} - File API không tồn tại hoặc có lỗi server`);
                }
                
                // Kiểm tra content-type
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    return response.text().then(text => {
                        console.error('Response không phải JSON:', text);
                        throw new Error('Server trả về HTML thay vì JSON. Có thể là:\n1. File API không tồn tại (404)\n2. Có lỗi PHP syntax\n3. Đường dẫn API sai\n\nĐường dẫn hiện tại: ' + API_URL);
                    });
                }
                
                return response.json();
            })
            .then(data => {
                loadingSpinner.style.display = 'none';
                btnRegister.disabled = false;
                btnRegister.innerHTML = '<i class="fas fa-user-plus"></i> Đăng Ký';
                
                if (data.success) {
                    showAlert('✓ Đăng ký thành công! Đang chuyển đến trang đăng nhập...', 'success');
                    setTimeout(() => {
                        window.location.href = 'dangnhap.html';
                    }, 2000);
                } else {
                    showAlert('✗ ' + (data.message || 'Đăng ký thất bại!'), 'error');
                }
            })
            .catch(error => {
                console.error('Chi tiết lỗi:', error);
                loadingSpinner.style.display = 'none';
                btnRegister.disabled = false;
                btnRegister.innerHTML = '<i class="fas fa-user-plus"></i> Đăng Ký';
                
                let errorMsg = 'Lỗi kết nối API!\n\n';
                errorMsg += 'Chi tiết: ' + error.message + '\n\n';
                errorMsg += 'Hướng dẫn khắc phục:\n';
                errorMsg += '1. Kiểm tra file API có tồn tại tại: ' + API_URL + '\n';
                errorMsg += '2. Đảm bảo server PHP đang chạy\n';
                errorMsg += '3. Kiểm tra Console (F12) để xem chi tiết lỗi\n';
                errorMsg += '4. Thay đổi biến API_URL ở đầu file JavaScript';
                
                showAlert(errorMsg, 'error');
            });
        });

        // Show alert message
        function showAlert(message, type) {
            const alert = document.getElementById('registerAlert');
            alert.innerHTML = message.replace(/\n/g, '<br>');
            alert.className = 'alert alert-' + type;
            alert.style.display = 'block';
            
            alert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            if (type === 'success') {
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 5000);
            }
        }
    </script>
</body>
</html>